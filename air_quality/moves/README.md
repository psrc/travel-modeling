# Updates to MOVES Emissions Rates for 2018 Base Year and 2022 RTP

The 2022 RTP resets the base year to 2018 and creates forecasts out to 2050, with intermediate years of 2030 and 2040. In addition, the latest version of MOVES (MOVES 3.0) was used to produce all rates. The input data was the latest available from WA Department of Ecology (2017). Improvements in the latest MOVES release allowed more complete automation of the input and output generation process. This document describes the processes used to generate these rates and how to update them with new data. 
## Input Data
Data was received from WA Ecology in 2020 for the latest available year, 2017. The original data (for four counties and the region [cnty_independent]) is available at Y:\Air Quality\RTP_2022\2017_data\from_ecology. The files are the text files required as input for a MOVES run. They serve as the template to create future input data, which assumes these characteristics remain the same into the future (except where explicitly defined by year within MOVES such as emission rates).  
## CSV Inputs
Since future-year input data is based on the 2017 template data, new data can be created for different years by copying these template files and changing the year field. This is done programmatically with the script **“create_moves_input_data.py”**.  The script was run to produce input CSV data for 2018, 2030, 2040, and 2050 for all four counties (and regional inputs), with data available here: Y:\Air Quality\RTP_2022\forecast_year_input_data
## Database Inputs
Once these CSV files are created, they must be organized into a database to be used in MOVES. In past versions of MOVES, these input databases had to be generated manually with the GUI program by creating input databases and manually selecting each file for every combination of years and counties. In MOVES 3.0, a new feature allows the user to script this process by modifying an XML file that MOVES uses to generate new input databases and import the data we already created. The script for this is **“create_input_database_xml.py.”**

Inputs to this script are the template XMLs that MOVES uses to create input databases. The script uses four templates that were generated manually in MOVES for different vehicle types (all, light, medium, and heavy): Y:\Air Quality\RTP_2022\MOVES3\batch_input_database_creation\templates. The script copies these files and makes necessary changes by changing paths to input CSV files based on the year and county. The output of this script is a set of XML files stored here: Y:\Air Quality\RTP_2022\MOVES3\batch_input_database_creation\files

Now that those XML files are generated they must be imported into the MOVES database. This is accomplished by running the following batch file: Y:\Air Quality\RTP_2022\MOVES3\batch_input_database_creation\**create_input_db.bat**. Note: change the path in this file to a location where the XMLs are stored. Their location on the Y drive will not work due to spaces in folder names. Copy them to a location on the T drive, or a local drive and edit the path in the .bat file. This .bat file will loop over each of the XML files and create a new table within the MOVES database containing the CSV data. Also note that to run the batch file (and any batch file that directly calls MOVES) refer to the following documentation: https://github.com/USEPA/EPA_MOVES_Model/blob/master/docs/CommandLineMOVES.md. (Specifically, the following call from command prompt: C:\Users\Public\EPA\MOVES\MOVES3.0> setenv). 

Check that the script completed by opening up the HeidiSQL GUI and searching the table list for the new input databases, which should be labeled as [county]_in_[vehicle type]_[year]_[database tag date], which are defined in the python script **create_input_database_xml.py**, which was run to generate the XML files. 
## Create MOVES Run Spec (MRS) Files
Moves Run Specification (MRS) files are used to tell MOVES which sets of rates and input database tables to run when generating emissions rates files. These are the final set of inputs that must be generated to run MOVES. Each unique set of rates requires a separate MRS file. The creation of these files is automated similarly to other scripts already presented. The **“create_mrs_files.py”* script generates the MRS files here: Y:\Air Quality\RTP_2022\moves_run_specs, using templates generated from MOVES here: Y:\Air Quality\RTP_2022\moves_run_spec_templates.
## Running MOVES
With all input databases generated, MOVES can now be run in batch mode to produce rates for any of the available inputs. The file: Y:\Air Quality\RTP_2022\MOVES3\ **batch_run.bat** is used to run any number of MRS files at a defined location. As for the other batch file, define the location of the input files in the batch file (replace the location on the T drive) and copy all the MRS files desired to run in that location. This could be any number of files. From the command prompt, run the batch_run.bat file using the methods referenced in https://github.com/USEPA/EPA_MOVES_Model/blob/master/docs/CommandLineMOVES.md. 
## Extracting Results
Upon completion of all MOVES scenario runs, the output databases should be populated. This can be confirmed by looking at the HeidiSQL GUI and searching for the output data. The table should be named in the convention of [county]_out_[vehicle_type]_[year]_[db_tag_date]. To automatically export a set of database rates use the script “export_moves_data.py.” This will generate a set of rate per distance files for each county and year specified. These files, which are the primary running and starting emissions rates are available here: Y:\Air Quality\RTP_2022\MOVES3\rates. 
## Creating Soundcast Rates
The final step of using MOVES rates is incorporating them fully as Soundcast inputs. This requires a small bit of reformatting and combining of all datasets into a single file, which is later to be converted as a database table for the soundcast database. Run the file “create_soundcast_input.py” to create a single CSV for running and starting emissions. This will be imported into the soundcast_inputs.db.


